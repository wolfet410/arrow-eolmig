// Library code specifically for account api code
var Arrow = require('arrow'),
    Q = require('q'),
    twarrow = require('twarrow');

// Helpers

// CRUD
module.exports.readAll = function(dnFilter) {
    // Gets a list of all accounts that match dnFilter
    var deferred = Q.defer();

    if (typeof dnFilter === undefined || dnFilter === '') {
        deferred.reject({ success: false, status: 422, caller: 'account.js>readAll',
                data: 'dnFilter cannot be empty' });
        return deferred.promise;
    }

    var viewModel = Arrow.getModel('appc.mysql.eolmig/Account');
    var query = 'SELECT * FROM Account WHERE dn LIKE "%' + dnFilter + '"';
    viewModel.query({ customSqlQuery: query }, function(err, results) {
        if (err) {
            deferred.reject({ success: false, status: 500, caller: 'account.js>readAll',
                data: err });
            return deferred.promise;
        }

        if (typeof results === 'undefined' || results.length === 0) {
            deferred.reject({ success: false, status: 422, caller: 'account.js>readAll',
                data: 'No results' });
            return deferred.promise;
        }

        deferred.resolve({ success: true, status: 200, caller: 'account.js>readAll', 
            data: results });
    });

    return deferred.promise;
};

module.exports.readSetext2 = function() {
    // Gets a list of all tasks
    var deferred = Q.defer();

    var viewModel = Arrow.getModel('appc.mysql.eolmig/Task');
    var query = 'SELECT * FROM Task';
    viewModel.query({ customSqlQuery: query }, function(err, results) {
        if (err) {
            deferred.reject({ success: false, status: 500, caller: 'account.js>readSetext2',
                data: err });
            return deferred.promise;
        }

        if (typeof results === 'undefined' || results.length === 0) {
            deferred.reject({ success: false, status: 422, caller: 'account.js>readSetext2',
                data: 'No results' });
            return deferred.promise;
        }

        deferred.resolve({ success: true, status: 200, caller: 'account.js>readSetext2', 
            data: results });
    });

    return deferred.promise;
};


module.exports.createSetext2 = function(dn) {
    // Creates a single setext2 task
    var deferred = Q.defer();

    var viewModel = Arrow.getModel('appc.mysql.eolmig/Task');
    var query = 'INSERT INTO Task (scriptName, parameter1) VALUES ("setext2", "' + dn + '")';
    viewModel.query({ customSqlQuery: query }, function(err, results) {
        if (err) {
            deferred.reject({ success: false, status: 500, caller: 'account.js>readSetext2',
                data: err });
            return deferred.promise;
        }

        if (typeof results === 'undefined' || results.length === 0) {
            deferred.reject({ success: false, status: 422, caller: 'account.js>readSetext2',
                data: 'No results' });
            return deferred.promise;
        }

        deferred.resolve({ success: true, status: 200, caller: 'account.js>readSetext2', 
            data: results });
    });

    return deferred.promise;
};

module.exports.updateSetext2 = function(dn, status) {
    // Updates a single setext2 task for a specific dn
    var deferred = Q.defer();

    var viewModel = Arrow.getModel('appc.mysql.eolmig/Task');
    var query = 'UPDATE Task SET status = "' + status + '" WHERE parameter1 = "' + dn + '"';
    viewModel.query({ customSqlQuery: query }, function(err, results) {
        if (err) {
            deferred.reject({ success: false, status: 500, caller: 'account.js>readSetext2',
                data: err });
            return deferred.promise;
        }

        if (typeof results === 'undefined' || results.length === 0) {
            deferred.reject({ success: false, status: 422, caller: 'account.js>readSetext2',
                data: 'No results' });
            return deferred.promise;
        }

        deferred.resolve({ success: true, status: 200, caller: 'account.js>readSetext2', 
            data: results });
    });

    return deferred.promise;
};